language: clojure
lein: lein2
jdk:
  - oraclejdk8
env:
  global:
  - IMAGEMAGICK_VERSION: '7.0.4-6'
  - LIBWEBP_VERSION: '0.6.0'
addons:
  apt:
    packages:
      - libjpeg-dev
      - libpng-dev
      - libgif-dev
      - libwebp-dev
      - build-essential
      - curl
before_install:
  - export PATH=$HOME/opt/bin:$PATH
  - export LD_FLAGS=-L$HOME/opt/lib
  - export LD_LIBRARY_PATH=/lib:/usr/lib:/usr/local/lib:$HOME/opt/lib
  - export CPATH=$CPATH:$HOME/opt/include
  - convert -version | grep $IMAGEMAGICK_VERSION || {
    export CORES=$(nproc) &&
    echo "Using $CORES cores for compiling..." &&
    cd /tmp &&
    curl -O https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-$LIBWEBP_VERSION.tar.gz &&
    tar xvzf libwebp-$LIBWEBP_VERSION.tar.gz &&
    cd libwebp-$LIBWEBP_VERSION &&
    ./configure --prefix=$HOME/opt &&
    make -j$CORES &&
    make install -j$CORES &&
    cd /tmp &&
    curl -O https://www.imagemagick.org/download/ImageMagick-$IMAGEMAGICK_VERSION.tar.gz &&
    tar xvzf ImageMagick-$IMAGEMAGICK_VERSION.tar.gz &&
    cd ImageMagick-$IMAGEMAGICK_VERSION &&
    ./configure --prefix=$HOME/opt --with-webp &&
    make -j$CORES &&
    make install -j$CORES &&
    $HOME/opt/bin/magick -version | grep $IMAGEMAGICK_VERSION &&
    cd $TRAVIS_BUILD_DIR; }
  - export VIGNETTE_THUMBNAIL_BIN=$TRAVIS_BUILD_DIR/bin/thumbnail
  - export IMAGEMAGICK_BASE=$HOME/opt
script:
  - convert --version | grep webp
  - lein2 midje
